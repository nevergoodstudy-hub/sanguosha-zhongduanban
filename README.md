# 三国杀 - 命令行终端版

<p align="center">
  <strong>一款在命令行终端中运行的三国杀卡牌游戏</strong>
</p>

<p align="center">
  <a href="https://github.com/nevergoodstudy-hub/sanguosha-zhongduanban/releases/latest">
    <img src="https://img.shields.io/github/v/release/nevergoodstudy-hub/sanguosha-zhongduanban?label=%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC" alt="Latest Release">
  </a>
  <img src="https://img.shields.io/badge/Python-3.8%2B-blue" alt="Python">
  <img src="https://img.shields.io/badge/Platform-Windows%20%7C%20macOS%20%7C%20Linux-green" alt="Platform">
</p>

```
╔══════════════════════════════════════════════════════════════╗
║                    【 三 国 杀 】                              ║
║                   命令行终端版 v1.1                           ║
╚══════════════════════════════════════════════════════════════╝
```

## 📥 下载

**Windows 用户**：直接下载可执行文件，无需安装 Python！

👉 [点击下载 sanguosha.exe](https://github.com/nevergoodstudy-hub/sanguosha-zhongduanban/releases/latest)

## 📋 目录

- [功能特性](#功能特性)
- [系统要求](#系统要求)
- [安装说明](#安装说明)
- [快速开始](#快速开始)
- [游戏规则](#游戏规则)
- [武将介绍](#武将介绍)
- [卡牌系统](#卡牌系统)
- [操作指南](#操作指南)
- [项目结构](#项目结构)
- [开发说明](#开发说明)
- [路线图](#路线图)

## ✨ 功能特性

### 核心功能
- ✅ 支持2-4人对战（1人玩家 + AI）
- ✅ 完整的身份模式：主公、忠臣、反贼、内奸
- ✅ 回合制游戏流程：准备→判定→摸牌→出牌→弃牌→结束
- ✅ 体力值系统和手牌上限机制
- ✅ 事件驱动架构与动作系统 ✨**New**

### 军争篇机制 ✨**v1.1.0 New**
- 🍺 **酒**：出牌阶段使下一张杀伤害+1，濒死时回复1点体力
- 🔥 **火杀/雷杀**：属性伤害类型，可触发铁索连环传导
- 🔗 **铁索连环**：横置/重置角色，属性伤害传导给其他被连环角色
- 🛡️ **藤甲**：普通杀无效，火焰伤害+1

### 卡牌系统
- ✅ **基本牌**：杀、闪、桃
- ✅ **军争基本牌**：🍺酒、🔥火杀、⚡雷杀 ✨**New**
- ✅ **锦囊牌**：决斗、南蛮入侵、万箭齐发、无中生有、过河拆桥、顺手牵羊、桃园结义、无懈可击
- ✅ **军争锦囊**：🔗铁索连环 ✨**New**
- ✅ **装备牌**：
  - 武器：青龙偃月刀、丈八蛇矛、诸葛连弩、贯石斧、麒麟弓、方天画戟、寒冰剑
  - 防具：八卦阵、仁王盾、藤甲 ✨**New**
  - 坐骑：赤兔、的卢、爪黄飞电、绝影、大宛、紫骍

### 武将系统（20+ 武将）

**标准版武将**：
| 武将 | 势力 | 技能 |
|------|------|------|
| 刘备 | 蜀 | 仁德、激将（主公技）|
| 曹操 | 魏 | 奸雄、护驾（主公技）|
| 孙权 | 吴 | 制衡、救援（主公技）|
| 关羽 | 蜀 | 武圣 |
| 张飞 | 蜀 | 咆哮 |
| 诸葛亮 | 蜀 | 观星、空城 |
| 周瑜 | 吴 | 英姿、反间 |
| 吕布 | 群 | 无双 |

**扩展武将**：
| 武将 | 势力 | 技能 |
|------|------|------|
| 马超 | 蜀 | 马术、铁骑 |
| 黄月英 | 蜀 | 集智、奇才 |
| 司马懿 | 魏 | 反馈、鬼才 |
| 夏侯惇 | 魏 | 刚烈 |
| 张辽 | 魏 | 突袭 |
| 大乔 | 吴 | 国色、流离 |
| 吕蒙 | 吴 | 克己 |
| 甘宁 | 吴 | 奇袭 |
| 黄盖 | 吴 | 苦肉 |
| 华佗 | 群 | 青囊、急救 |
| 貂蝉 | 群 | 离间、闭月 |
| 魏延 | 蜀 | 狂骨 |
| 徐晃 | 魏 | 断粮 |
| 曹仁 | 魏 | 据守 |
| 孙尚香 | 吴 | 结姻、枭姬 |

### AI系统
- 🟢 **简单模式**：随机出牌
- 🟡 **普通模式**：基础策略决策
- 🔴 **困难模式**：深度策略 + 嘲讽值系统

## 💻 系统要求

- **Python**: 3.8 或更高版本
- **操作系统**: Windows / macOS / Linux
- **终端**: 支持UTF-8编码的终端

## 📦 安装说明

### 1. 克隆或下载项目

```bash
# 如果使用Git
git clone <repository-url>
cd sanguosha

# 或者直接下载并解压
```

### 2. 安装依赖（可选）

```bash
# 安装colorama以获得彩色输出支持（可选）
pip install colorama
```

### 3. 验证安装

```bash
python main.py
```

## 🚀 快速开始

### 启动游戏

```bash
cd sanguosha
python main.py
```

### 游戏流程

1. **主菜单**：选择开始新游戏、查看规则或退出
2. **选择人数**：2-4人对战
3. **选择难度**：简单/普通/困难
4. **选择武将**：从3个随机武将中选择1个
5. **开始游戏**：进入游戏主循环

## 📖 游戏规则

### 胜利条件

| 身份 | 胜利条件 |
|------|----------|
| 主公 | 消灭所有反贼和内奸 |
| 忠臣 | 保护主公，帮助主公获胜 |
| 反贼 | 消灭主公 |
| 内奸 | 最后存活（先帮主公清反贼，再与主公单挑）|

### 回合流程

1. **准备阶段** - 触发某些技能（如诸葛亮的观星）
2. **判定阶段** - 处理延时锦囊
3. **摸牌阶段** - 从牌堆摸2张牌
4. **出牌阶段** - 可以使用手牌和技能
5. **弃牌阶段** - 手牌超过体力值需弃牌
6. **结束阶段** - 回合结束

### 特殊规则

- 每回合只能使用一张【杀】（某些武将/装备除外）
- 手牌上限等于当前体力值
- 杀死反贼摸3张牌
- 主公杀忠臣需弃置所有牌
- 🍺 每回合只能使用一张酒（濒死时不限）
- 🔗 属性伤害（火/雷）会触发铁索连环传导

## ⚔️ 武将介绍

### 刘备 [蜀]
- **仁德**：出牌阶段，可以将任意数量的手牌交给其他角色。每回合给出第二张牌时，回复1点体力。
- **激将**（主公技）：当你需要使用或打出【杀】时，可以令其他蜀势力角色代替。

### 曹操 [魏]
- **奸雄**：受到伤害后，可以获得造成伤害的牌。
- **护驾**（主公技）：当你需要使用或打出【闪】时，可以令其他魏势力角色代替。

### 孙权 [吴]
- **制衡**：出牌阶段限一次，可以弃置任意数量的牌，然后摸等量的牌。
- **救援**（主公技）：锁定技，其他吴势力角色对你使用【桃】时，额外回复1点体力。

### 关羽 [蜀]
- **武圣**：可以将红色牌当【杀】使用或打出。

### 张飞 [蜀]
- **咆哮**：锁定技，出牌阶段，使用【杀】无次数限制。

### 诸葛亮 [蜀]
- **观星**：准备阶段，观看牌堆顶X张牌（X为存活角色数，最多5），然后将这些牌以任意顺序放置于牌堆顶或底。
- **空城**：锁定技，若没有手牌，不是【杀】和【决斗】的合法目标。

### 周瑜 [吴]
- **英姿**：摸牌阶段，可以多摸一张牌。
- **反间**：出牌阶段限一次，选择一名其他角色并展示一张手牌，令其猜花色。若不同，对其造成1点伤害。

### 吕布 [群]
- **无双**：锁定技，使用【杀】需要两张【闪】抵消；使用或被【决斗】时，对方每次需打出两张【杀】。

## 🃏 卡牌系统

### 基本牌

| 卡牌 | 效果 |
|------|------|
| 杀 | 对攻击范围内一名角色使用，需出闪否则受1点伤害 |
| 🔥 火杀 | 造成火焰伤害，可触发铁索连环传导、藤甲+1伤害 |
| ⚡ 雷杀 | 造成雷电伤害，可触发铁索连环传导 |
| 闪 | 被杀时打出，抵消杀的效果 |
| 桃 | 回复1点体力，或濒死时救援 |
| 🍺 酒 | 出牌阶段使下一张杀+1伤害；濒死时回复1体力 |

### 锦囊牌

| 卡牌 | 类型 | 效果 |
|------|------|------|
| 决斗 | 单体 | 与目标轮流出杀，先不出者受1点伤害 |
| 南蛮入侵 | AOE | 所有其他角色需出杀，否则受1点伤害 |
| 万箭齐发 | AOE | 所有其他角色需出闪，否则受1点伤害 |
| 无中生有 | 自用 | 摸2张牌 |
| 过河拆桥 | 单体 | 弃置目标区域里的一张牌 |
| 顺手牵羊 | 单体 | 获得距离为1的目标区域里的一张牌 |
| 桃园结义 | 全体 | 所有角色回复1点体力 |
| 无懈可击 | 反制 | 抵消一张锦囊牌的效果 |
| 🔗 铁索连环 | 连环 | 选择1-2名角色横置/重置；或重铸摸一张牌 |

### 装备牌

#### 武器
| 装备 | 范围 | 效果 |
|------|------|------|
| 诸葛连弩 | 1 | 出牌阶段可以使用任意数量的杀 |
| 青龙偃月刀 | 3 | 杀被闪抵消时，可以继续使用杀 |
| 丈八蛇矛 | 3 | 可以将两张手牌当杀使用或打出 |
| 贯石斧 | 3 | 杀被闪抵消时，可以弃两张牌使杀生效 |
| 麒麟弓 | 5 | 杀造成伤害时，可以弃置目标的坐骑 |
| 方天画戟 | 4 | 杀是最后手牌时，可以额外指定两个目标 |
| 寒冰剑 | 2 | 杀造成伤害时，可以改为弃置目标两张牌 |

#### 防具
| 装备 | 效果 |
|------|------|
| 八卦阵 | 需要闪时可判定，红色视为出闪 |
| 仁王盾 | 黑色的杀对你无效 |
| 🌿 藤甲 | 锁定技，普通杀/南蛮/万箭无效；火焰伤害+1 |

#### 坐骑
| 装备 | 类型 | 效果 |
|------|------|------|
| 赤兔 | -1马 | 你计算与其他角色的距离-1 |
| 大宛 | -1马 | 你计算与其他角色的距离-1 |
| 紫骍 | -1马 | 你计算与其他角色的距离-1 |
| 的卢 | +1马 | 其他角色计算与你的距离+1 |
| 爪黄飞电 | +1马 | 其他角色计算与你的距离+1 |
| 绝影 | +1马 | 其他角色计算与你的距离+1 |

## 🎮 操作指南

### 基本操作

| 按键 | 功能 |
|------|------|
| P | 出牌 - 选择手牌使用 |
| S | 技能 - 使用武将技能 |
| D | 弃牌 - 手动弃牌 |
| E | 结束 - 结束当前回合 |
| H | 帮助 - 显示帮助信息 |
| Q | 退出 - 退出游戏 |

### 选择操作

- 输入数字选择对应的玩家或卡牌
- 输入 0 或 C 取消当前操作

### 界面说明

```
╔══════════════════════════════════════════════════════════════╗
║ 【三国杀 - 命令行版】 第1回合                                 ║
╠══════════════════════════════════════════════════════════════╣
║ [AI_2] 曹操 ♥♥♥♥ 手牌:5 [?] [青龙偃月刀][八卦阵]             ║
║ [AI_3] 周瑜 ♥♥♥ 手牌:3 [?]                                   ║
╠══════════════════════════════════════════════════════════════╣
║ 【当前回合】                                                  ║
║ [玩家1] 刘备(你) ♥♥♥♥♥ 身份:主公                             ║
║ 装备: [诸葛连弩][-1马:的卢]                                   ║
║ 手牌: [1]杀♠A [2]杀♥K [3]闪♦Q [4]桃♣J [5]决斗♠10            ║
╠══════════════════════════════════════════════════════════════╣
║ 【战斗日志】                                                  ║
║ AI_2 使用了【杀】                                             ║
║ 你 打出了【闪】                                               ║
╠══════════════════════════════════════════════════════════════╣
║ > 请选择操作:                                                 ║
║   [P]出牌 [S]使用技能 [E]结束回合 [H]帮助 [Q]退出             ║
╚══════════════════════════════════════════════════════════════╝
```

## 📁 项目结构

```
sanguosha/
├── main.py                      # 游戏入口
├── README.md                    # 说明文档
├── PROJECT_OVERVIEW.html         # 项目概览（HTML）
├── PROJECT_ROADMAP.md           # 项目路线图
├── IMPROVEMENT_PLAN.md          # 改进计划
├── GAMEPLAY_IMPROVEMENTS.md     # 玩法扩展计划
├── DEVELOPER_EXECUTION_PLAN.md  # 开发者可执行改进实施文档
├── requirements.txt             # 依赖列表
├── game/                        # 游戏核心模块
│   ├── __init__.py
│   ├── engine.py                # 游戏引擎（含 headless 接口）
│   ├── player.py                # 玩家类
│   ├── card.py                  # 卡牌类（含军争类型）
│   ├── hero.py                  # 武将类
│   ├── skill.py                 # 技能系统
│   ├── events.py                # 事件总线
│   └── actions.py               # 动作系统
├── ai/                          # AI模块
│   ├── __init__.py
│   └── bot.py                   # AI逻辑（嘘讽值系统）
├── ui/                          # 界面模块
│   ├── __init__.py
│   ├── terminal.py              # 终端显示
│   └── ascii_art.py             # ASCII艺术
├── data/                        # 数据文件
│   ├── cards.json               # 卡牌数据
│   └── heroes.json              # 武将数据
├── tests/                       # 测试文件
│   ├── test_game.py             # 基础单元测试
│   ├── test_events.py           # 事件系统测试
│   ├── test_juunzheng.py        # 军争机制测试 ✨New
│   ├── test_auto_battle.py      # 自动对战测试
│   └── test_auto_battle_stress.py  # 压力测试（100局+）
└── dist/                        # 打包产物
    └── sanguosha.exe            # Windows 可执行文件
```

## 🔧 开发说明

### 代码规范

- 遵循 PEP8 规范
- 使用 Type Hints 类型注解
- 完整的 docstring 文档
- 模块化设计，低耦合高内聚

### 扩展指南

#### 添加新武将

1. 在 `data/heroes.json` 中添加武将数据
2. 在 `game/skill.py` 的 `SkillSystem` 中实现技能逻辑
3. 添加技能处理器到 `_skill_handlers` 字典

#### 添加新卡牌

1. 在 `data/cards.json` 中添加卡牌数据
2. 在 `game/engine.py` 的 `use_card` 方法中添加处理逻辑

### 运行测试

```bash
# 单元测试
python -m pytest tests/ -v

# 军争机制测试
python -m pytest tests/test_juunzheng.py -v

# 压力测试（100局 AI 对战）
python tests/test_auto_battle_stress.py
```

### 打包为可执行文件

```bash
# 方法1：使用打包脚本（推荐）
build.bat

# 方法2：手动打包
pip install pyinstaller
pyinstaller sanguosha.spec --noconfirm
```

打包完成后，可执行文件位于 `dist/三国杀.exe`，可直接运行无需Python环境。

## 📍 路线图

详细的项目演进规划请查看 **[PROJECT_ROADMAP.md](./PROJECT_ROADMAP.md)**

更细化的开发执行任务清单请查看 **[DEVELOPER_EXECUTION_PLAN.md](./DEVELOPER_EXECUTION_PLAN.md)**

项目整体概览（可视化）请查看 **[PROJECT_OVERVIEW.html](./PROJECT_OVERVIEW.html)**

**已完成**：
- ✅ 阶段1 T1-1：统一压力测试与正式引擎逻辑
- ✅ 阶段1 T1-2：打通军争基础机制（酒/火杀/雷杀/铁索连环）
- ✅ 阶段1 T1-3：补充关键规则单元测试

**规划中**：
- ⏳ 阶段2：扩展军争牌与精选武将
- ⏳ 阶段2：AI 价值评估与困难模式增强
- ⏳ 阶段3：技能原子化与数据驱动 SkillSystem

## 📝 版本历史

### Unreleased
- **开发文档**：新增 [DEVELOPER_EXECUTION_PLAN.md](./DEVELOPER_EXECUTION_PLAN.md)，用于指导后续改进实施（里程碑/验收/测试/回滚/安全审计）
- **项目概览**：新增 [PROJECT_OVERVIEW.html](./PROJECT_OVERVIEW.html)，用于快速浏览架构、机制与路线图
- **富 UI 稳定性**：修复 Rich 标记标签闭合错误导致的 `MarkupError`，并为 Rich UI 补齐 `ask_for_wuxie()` 交互接口，避免交互模式运行时崩溃

### v1.2.0 (2025-01) 🚀 规则闭环与AI增强
- **M1 规则闭环**：
  - headless 判定阶段对齐正式逻辑（闪电/乐不思蜀/兵粮寸断完整支持）
  - 延时锦囊"出牌→入判定区"闭环实现
  - 无懈可击机制完整实现（锦囊生效前拦截、AI决策、连环无懈）
  - 牌堆耗尽与判定抽牌边界防护
- **M2 动作系统**：
  - 引擎统一动作入口 `execute_action()`
  - 动作序列记录（用于回放）
- **M3 可复现性**：
  - 统一随机种子注入与记录（`setup_headless_game(seed=xxx)`）
  - 动作日志自动记录
- **M4 AI增强**：
  - 局势评分函数 `evaluate_game_state()`
  - 玩家战力评估 `_calculate_player_power()`
  - 危险等级计算 `_calculate_danger_level()`
  - 身份推断系统 `infer_identity()` / `record_behavior()`
- **压力测试**：100局全部通过，成功率100%

### v1.1.0 (2025-11) ✨ Latest
- **军争基础机制**：酒、火杀/雷杀、铁索连环、藤甲
- **统一引擎接口**：新增 headless 对战 API
- **压力测试重构**：使用正式引擎规则
- **新增测试用例**：13 个军争机制测试
- **Windows 可执行文件**：打包 sanguosha.exe

### v1.0.0 (2024)
- 初始版本
- 完整的基础游戏机制
- 8 个标准版武将
- 3 种 AI 难度
- 命令行界面

## 📄 许可证

本项目仅供学习和娱乐目的。三国杀是游卡桌游的注册商标。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

建议先阅读 [PROJECT_ROADMAP.md](./PROJECT_ROADMAP.md) 了解项目规划。

---

**享受游戏！** 🎮

⭐ 如果觉得这个项目有帮助，请给个 Star 支持一下！
