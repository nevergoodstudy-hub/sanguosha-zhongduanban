# 三国杀命令行版：项目路线图（Project Roadmap)

> 本文件用于汇总本仓库后续演进的整体规划，包括架构重构、玩法扩展、AI 优化、性能与测试，以及 UI/体验改进等方面的具体可行方案。
> 详细技术分析可参考已有文档：`IMPROVEMENT_PLAN.md`（架构/代码层面）与 `GAMEPLAY_IMPROVEMENTS.md`（玩法与内容层面）。

---

## 1. 项目目标与范围

- **目标 1：稳定可玩的本地身份局三国杀引擎**  
  保持当前命令行版的稳定性，在此基础上逐步完善军争机制、扩展武将与卡牌，保证规则正确性。

- **目标 2：可扩展的规则与内容平台**  
  通过事件总线、动作系统和数据驱动技能，使新增武将/模式/扩展包只需少量或零引擎改动即可接入。

- **目标 3：可观察、可压测、便于 AI 研究的实验场**  
  提供统一的自动对战与压力测试接口，为 AI 策略改进、平衡性分析和未来可能的联机/GUI 奠定基础。

本路线图聚焦于：**单机场景 + 身份局规则**。国战、更多 PVE 模式可在后续阶段基于本路线图扩展。

---

## 2. 当前项目现状简述

- **功能层面**  
  - 支持 2–4 人身份局（1 人类 + 多 AI），含主公/忠臣/反贼/内奸规则。  
  - 基本牌、常见锦囊、武器/防具/坐骑齐备，8 名经典武将。  

- **架构层面**  
  - `game/engine.py` 提供核心回合与用牌逻辑，`player.py`/`card.py`/`hero.py`/`skill.py` 建模主要对象。  
  - 已引入 **事件总线 `EventBus` + `EventType` + `GameEvent`** 与 **动作系统 `GameAction` / `PlayCardAction` / `UseSkillAction`**，正在从“过程式”向“事件驱动 + 动作驱动”演进。  
  - 卡牌与武将数据均从 JSON 加载，具备良好的数据驱动基础。

- **技能与军争机制准备**  
  - `DamageType`、`CardSubtype.FIRE_ATTACK / THUNDER_ATTACK / ALCOHOL`、`Player.is_chained` 等为军争篇预留了关键结构。  
  - 部分军争机制尚未彻底打通（如属性伤害传导、铁索连环的连锁结算）。

- **AI 与测试**  
  - `ai/bot.py` 提供简单/普通/困难 3 档 AI；普通难度已实现基于规则的优先级决策，困难难度加入“嘲讽值”评估。  
  - `tests/test_auto_battle.py` 与 `tests/test_auto_battle_stress.py` 支持自动对战与 100+ 局压力测试，但压力测试对局使用了一套与正式引擎略有差异的简化逻辑。  
  - 已有基础单元测试（如 `tests/test_game.py`, `tests/test_events.py`）。

---

## 3. 主要改进维度与方向

### 3.1 架构与规则引擎

- 完成 **事件驱动闭环**：
  - 将伤害、回复、判定、濒死、死亡等核心流程统一收敛到少量方法（如 `deal_damage`、`recover`、`judge`）。  
  - 所有这些方法内部统一发出 `EventType.DAMAGE_INFLICTING / DAMAGE_INFLICTED / DYING / DEATH / JUDGE_START / JUDGE_RESULT` 等事件，由技能系统与 UI 订阅响应该事件。

- **动作系统统一入口**：
  - 所有玩家行为（人类+AI）统一封装为 `GameAction` 子类，通过 `GameEngine.execute_action(action)` 处理。  
  - 在该入口中执行：合法性校验 → 状态更新 → 事件发布，便于联机、回放与 AI 搜索。

- **清理 UI 耦合**：
  - 长期目标为 `GameEngine` 完全无 `print/input/ui.show_xxx`，交互全部通过事件与 `GameRequest/GameResponse` 完成。  
  - 现阶段逐步迁移，保留向后兼容。

### 3.2 玩法与内容扩展

- 在保持当前平衡与体验的前提下，优先：
  - **打通军争基础机制**：酒、火杀/雷杀、铁索连环、藤甲等；  
  - 逐步引入 **神话再临/界限突破** 中机制相对简单的高人气武将；  
  - 适度增加新模式（如 1v1/Arena、简化虎牢关 PVE），丰富单机玩法。

### 3.3 AI 与自动对战

- 统一 AI 与压力测试的规则入口，使所有自动对局都覆盖“正式规则引擎”。  
- 在现有规则基础上，引入**价值评估驱动的决策**（局势评分函数）与更完善的身份推断逻辑。  
- 为 AI 预留“完全信息 / 部分信息”两种模式接口，以兼顾调试与真实对战体验。

### 3.4 性能与压力测试

- 提供统一的 `simulate_battle(config)` 风格接口，用于批量对局与策略评估。  
- 增强可诊断性：记录关键动作序列与随机种子，实现问题对局的可重现与可回放。

### 3.5 工程化与测试

- 扩展 `pytest` 覆盖范围，涵盖距离计算、濒死结算、技能触发、军争机制等关键路径。  
- 引入 `mypy` 与 `ruff/flake8` 等静态分析工具，以 CI/脚本形式运行。  
- 保持代码风格、类型注解与文档的一致性，方便新贡献者上手。

### 3.6 UI 与体验

- 短期：进一步美化终端输出，增加日志等级与 AI 行动速度等配置项。  
- 中长期：在引擎与事件系统稳定后，探索 PyQt / Web GUI 等前端，实现更友好的可视化对战。

---

## 4. 分阶段实施计划

> 下面的时间预估仅用于相对优先级与批次划分，实际节奏可根据个人精力或团队安排调整。

### 4.1 阶段 0：基线版本（已完成）

- **状态**：已完成，用作后续演进的稳定回滚点。  
- **主要内容**：
  - 命令行版基本身份局规则与 8 名武将；  
  - 事件总线 `EventBus` 与 `EventType` 初版；  
  - 动作系统基础类 `GameAction` 及若干子类；  
  - 基础单元测试与自动对战脚本。  

**风险与控制**：
- 将当前主分支视为可随时回退的“安全版本”。在进行后续重构时，保持小步提交、必要时拉特性分支开发。

---

### 4.2 阶段 1：短期（约 1–2 周）

聚焦“**统一规则入口 + 打通军争基础 + 增强测试**”，在不大幅改变现有玩法的前提下提升规则一致性与稳定性。

#### 4.2.1 任务清单

1. **T1-1：统一压力测试与正式引擎**  
   - 调整 `tests/test_auto_battle_stress.py`：
     - 尽量复用 `GameEngine` 的回合/用牌/结算逻辑，而非自定义简化实现；  
     - 或封装统一的无 UI 驱动函数（如 `simulate_round(engine, bots)`），让 StressTester 只负责调度，而不重写规则。  
   - 验收标准：
     - 压测代码调用路径与正常对战尽可能一致；  
     - 出现异常时能直接根据动作序列与引擎状态排查，而无需在两套逻辑之间对比。

2. **T1-2：打通军争基础机制（酒 / 火杀 / 雷杀 / 铁索连环）**  
   - 根据 `CardSubtype` 与 `DamageType`，补齐：
     - 酒：`Player.use_alcohol` + `consume_drunk` 与 `use_card(杀)`/伤害结算的完整联动；  
     - 火杀/雷杀：在 `deal_damage`（或等效函数）中区分属性伤害，为铁索连环与藤甲等后续交互做准备；  
     - 铁索连环：根据 `Player.is_chained` 和属性伤害，通过事件或递归逻辑实现伤害传导。  
   - 验收标准：
     - 针对上述机制设计的单元测试全部通过；  
     - 使用军争牌的对局不会出现明显规则错误或崩溃。

3. **T1-3：补充关键规则单元测试**  
   - 为以下逻辑编写测试用例：
     - 距离与攻击范围（含坐骑与武器）；  
     - 濒死→求桃→死亡流程；  
     - 代表性技能：武圣、咆哮、英姿、奸雄等；  
     - 基础军争牌（酒、火杀/雷杀、铁索连环）的主要规则路径。  
   - 验收标准：
     - 对上述逻辑的小改动能被测试快速发现；  
     - 在 CI 或本地脚本中可一键运行所有测试用例。

#### 4.2.2 阶段 1 风险与控制

- **风险点**：
  - 军争机制接入可能改变部分对局行为，引入新的规则 Bug；  
  - 压力测试逻辑迁移到正式引擎后，如果存在旧 Bug，可能在短期内暴露更多问题。  
- **控制措施**：
  - 小步重构，每个子任务完成后立即运行：
    - 全量单元测试；  
    - 一小批自动对战（例如 50–100 局），观察错误率与平均回合数变化。  
  - 对军争相关改动单独打 Tag 或标注，以便出现问题时快速二分回退。

---

### 4.3 阶段 2：中期（约 3–6 周）

在阶段 1 稳定的基础上，聚焦**内容扩展 + AI 增强 + 可回放性**。

#### 4.3.1 任务清单

1. **T2-1：扩展军争牌与精选武将**  
   - 参考 `GAMEPLAY_IMPROVEMENTS.md`，优先选择：
     - 规则简单、依赖已实现机制的军争牌（如火攻、兵粮寸断等）；  
     - 机制直观、实现成本可控的神话再临/界限突破武将（如孙坚【英魂】、部分卖血流武将）。  
   - 验收标准：
     - 新增内容的基础规则用例齐全；  
     - 在压测中，包含新武将/新牌的对局错误率可接受。

2. **T2-2：AI 价值评估与困难模式增强**  
   - 基于现有的 `_smart_discard` 价值表，构建更系统的“局势评分函数”：
     - 结合手牌差、血量差、装备差、身份与势力关系；  
     - 在出牌决策中，优先选择局势评分提升最大的动作。  
   - 将“嘲讽值系统”与身份推断更紧密地结合，用于目标选择（尤其在困难 AI 中）。  
   - 验收标准：
     - 在相同随机种子与初始条件下，困难 AI 平均表现优于普通 AI；  
     - 不显著增加回合耗时或导致明显卡顿。

3. **T2-3：动作日志与简易回放能力**  
   - 在引擎层记录每局的 `GameAction` 序列与关键事件（可选保存到文件）；  
   - 提供一个仅在开发/调试模式使用的“重放函数”，可以根据动作序列复现实验对局。  
   - 验收标准：
     - 压测中出现的错误局可通过记录的动作序列稳定复现；  
     - 重放结果与原对局在关键状态上保持一致。

#### 4.3.2 阶段 2 风险与控制

- **风险点**：
  - 内容扩展+AI 增强会显著提升状态空间，可能暴露性能与规则边界问题；  
  - 回放功能如果实现不严谨，可能出现“重放结果与原结果不一致”的情况。  
- **控制措施**：
  - 对每个新增武将/卡牌，设计**专门的最小测试场景**；  
  - 在压测中单独统计“使用新内容的对局”与“仅老内容对局”的错误率；  
  - 为回放工具加入版本号与校验信息，避免跨版本复现导致混淆。

---

### 4.4 阶段 3：长期（约 2 个月以上）

聚焦“**更通用的规则引擎 + 扩展/脚本化 + 更丰富前端**”。

#### 4.4.1 任务清单

1. **T3-1：技能/效果原子化与更数据驱动的 SkillSystem**  
   - 引入“触发时机 + 条件 + 原子效果”的通用描述模型：
     - 原子效果示例：`DrawCards`, `DiscardCards`, `ModifyDamage`, `ConvertCard`, `ForceUseSlash` 等；  
     - 简单技能仅依赖配置即可实现，无需编写大量 Python 代码。  
   - 将现有部分技能迁移到该模型下，保留复杂技能的自定义处理能力。  

2. **T3-2：脚本扩展或外挂式扩展包支持**  
   - 借鉴 QSanguosha/FreeKill：探索以 Python 插件或轻量脚本（如 Lua）描述武将与卡牌逻辑；  
   - 将扩展武将/牌包放入独立目录/仓库，通过配置加载，减少对主仓库的侵入性修改。  

3. **T3-3：联机/GUI 前端探索**  
   - 在事件与动作系统足够稳定后：
     - 设计简单明了的“网络协议或消息格式”，对应 `GameAction` 与 `GameEvent`；  
     - 基于 PyQt/Qt 或 Web 技术实现基础 GUI，对接现有引擎。  

#### 4.4.2 阶段 3 风险与控制

- **风险点**：
  - 技能系统与扩展机制的大重构有可能与旧版本完全不兼容；  
  - 引入脚本语言与联机功能后，会带来新的安全问题（如脚本执行安全、网络输入验证、潜在外挂接口）。  
- **控制措施**：
  - 清晰划分版本线（例如 v1.x：终端+本地；v2.x：脚本化+扩展；v3.x：联机/GUI）；  
  - 对脚本扩展与联机功能单独评估安全需求，引入沙箱、权限控制和严格的输入校验。

---

## 5. 总体安全与风险审查

1. **当前路线图对运行时安全的直接影响**  
   - 本文件仅为规划文档，不包含可执行代码，不会直接改变当前版本的安全属性。  
   - 真正影响安全性的改动集中在：军争机制接入、AI 行为增强、联机/脚本扩展等阶段任务中，需要在实施时逐项评估。

2. **通用安全建议**  
   - 在所有进入引擎的 `GameAction` 入口统一做严格合法性校验，防止未来联机模式下的作弊或恶意输入；  
   - 为联机与脚本扩展功能设计最小权限原则与隔离机制；  
   - 对关键规则（伤害结算、判定、濒死/死亡、身份胜负判定）保持高测试覆盖，避免在重构中产生“静默错误”。

3. **回滚与发布策略**  
   - 重大修改前建立 Tag 或分支，保持可回退能力；  
   - 在合并前通过“单元测试 + 小规模压测 + 手工试玩”三重验证；  
   - 推荐在 README 或发行说明中记录每个版本的规则/行为变更，便于排查历史问题。

---

## 6. 协作与维护建议

- 使用 Issue/PR 跟踪每个阶段任务（T1-x/T2-x/T3-x），在标题或标签中标明所属阶段与改进维度。  
- 对重要设计决策（如新的事件类型、原子效果设计、扩展接口）撰写简短 ADR（Architecture Decision Record），方便后续回顾。  
- 鼓励外部贡献者在实现新武将/新牌/新模式时：
  - 先在 Issue 中讨论设计方案；  
  - 提交包含最小测试用例的 PR；  
  - 避免直接在引擎深处添加与特定武将/牌高度耦合的逻辑。

> 本路线图会随着项目进展不断更新，建议在每一阶段结束时回顾：
> - 哪些目标已达成，是否需要调整后续计划；
> - 是否引入了新的风险点，是否需要新增测试或安全策略。
